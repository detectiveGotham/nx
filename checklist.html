<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Themed Productivity Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Orbitron:wght@400;700&family=Roboto+Condensed:wght@400;700&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Base styles */
        body { transition: background-color 0.5s, color 0.5s; }
        :root { --theme-transition: all 0.3s ease-in-out; }

        /* Themes */
        .theme-classic { --bg-primary: #FFFFFF; --bg-secondary: #F3F4F6; --text-primary: #1F2937; --text-secondary: #4B5563; --accent-primary: #3B82F6; --accent-secondary: #10B981; --border-color: #D1D5DB; font-family: 'VT323', monospace; }
        .theme-wonder-woman { --bg-primary: #0A192F; --bg-secondary: #172A45; --text-primary: #CCD6F6; --text-secondary: #8892B0; --accent-primary: #F59E0B; --accent-secondary: #DC2626; --border-color: #233554; font-family: 'Cinzel', serif; }
        .theme-iron-man { --bg-primary: #111827; --bg-secondary: #1F2937; --text-primary: #E5E7EB; --text-secondary: #9CA3AF; --accent-primary: #06B6D4; --accent-secondary: #EF4444; --border-color: #374151; font-family: 'Orbitron', sans-serif; }
        .theme-batman { --bg-primary: #000000; --bg-secondary: #171717; --text-primary: #F5F5F5; --text-secondary: #A3A3A3; --accent-primary: #FDE047; --accent-secondary: #6B7280; --border-color: #404040; font-family: 'Roboto Condensed', sans-serif; }

        /* Dynamic styles */
        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .accent-primary { color: var(--accent-primary); }
        .accent-secondary { color: var(--accent-secondary); }
        .border-theme { border-color: var(--border-color); }
        .btn-theme-primary { background-color: var(--accent-primary); color: var(--bg-primary); }
        .btn-theme-secondary { background-color: var(--accent-secondary); color: var(--bg-primary); }
        .hover-accent-primary:hover { color: var(--accent-primary); }

        .checklist-item { border-left: 2px solid var(--border-color); padding-left: 1rem; margin-top: 0.5rem; }
        .collapsible-icon { transition: transform 0.3s; }
        .collapsed .collapsible-icon { transform: rotate(-90deg); }
        .collapsed .children-container { display: none; }
        .item-checkbox:checked ~ .item-title { text-decoration: line-through; color: var(--text-secondary); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-primary text-primary">

    <!-- Loading View (Gatekeeper is checking auth) -->
    <div id="loading-view" class="flex flex-col items-center justify-center min-h-screen">
        <div class="loader"></div>
        <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">Loading your data...</p>
    </div>

    <!-- Main App Container (Hidden until data is loaded) -->
    <div id="app-container" class="hidden max-w-7xl mx-auto p-4">
        
        <header class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b border-theme">
            <div class="flex items-center gap-4">
                <h1 id="main-title" class="text-4xl font-bold accent-primary cursor-pointer" contenteditable="true">Productivity Hub</h1>
                <span id="save-indicator" class="text-sm text-secondary transition-opacity duration-500 opacity-0">✓ Saved to Cloud</span>
            </div>
            <div class="flex items-center space-x-4">
                <a href="./focus.html" id="focus-header-btn" class="btn-theme-primary p-2 rounded-md">Focus</a>
                <div id="theme-switcher" class="flex items-center space-x-2">
                    <button data-theme="classic" class="theme-btn p-2 rounded-full bg-blue-500 border-2 border-transparent" title="Classic"></button>
                    <button data-theme="wonder-woman" class="theme-btn p-2 rounded-full bg-yellow-500 border-2 border-transparent" title="Wonder Woman"></button>
                    <button data-theme="iron-man" class="theme-btn p-2 rounded-full bg-cyan-400 border-2 border-transparent" title="Iron Man"></button>
                    <button data-theme="batman" class="theme-btn p-2 rounded-full bg-yellow-400 border-2 border-transparent" title="Batman"></button>
                </div>
                <button id="logout-btn" class="text-secondary hover-accent-primary" title="Logout">
                    <i class="fas fa-sign-out-alt fa-2x"></i>
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <!-- Achievements -->
                <div class="bg-secondary p-4 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-2 text-primary">Achievements</h2>
                    <div id="achievement-badge" class="w-24 h-24 mx-auto rounded-full flex items-center justify-center text-4xl font-bold cursor-pointer mb-2 transition-transform duration-300 hover:scale-110">
                        <span id="badge-level">0</span>
                    </div>
                    <p id="main-quote" class="text-center text-secondary italic" contenteditable="true">"The secret of getting ahead is getting started."</p>
                </div>
            </div>

            <div class="lg:col-span-2 bg-secondary p-4 rounded-lg shadow-md">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <h2 class="text-3xl font-bold text-primary">Checklist</h2>
                    <div class="flex gap-2">
                        <button id="bulk-add-btn" class="btn-theme-secondary p-2 rounded-md">Bulk Add</button>
                        <button id="add-subject-btn" class="btn-theme-primary p-2 rounded-md">Add Subject</button>
                    </div>
                </div>
                 <div class="mb-4">
                    <input type="text" id="search-bar" class="w-full p-2 rounded-md bg-primary text-primary border border-theme" placeholder="Search tasks...">
                </div>
                <div id="checklist-container"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="bulk-add-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50 p-4">
        <div class="bg-secondary p-6 rounded-lg max-w-2xl w-full modal">
            <h2 class="text-2xl font-bold mb-4 text-primary">Bulk Add From Text</h2>
            <p class="text-sm text-secondary mb-2">Use format: `Subject: Name`, `Section: Name`, etc. Indent with spaces for hierarchy.</p>
            <textarea id="bulk-add-input" class="w-full p-2 rounded-md bg-primary text-primary border border-theme" rows="10" placeholder="Subject: My Project\n  Section: Research\n    Topic: Competitors\n      Subtopic: Analyze competitor A"></textarea>
            <div class="flex justify-between mt-4">
                <button id="process-bulk-add" class="btn-theme-primary p-2 rounded-md">Add to Checklist</button>
                <button id="close-bulk-add-modal" class="p-2 rounded-md">Cancel</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCWcYAAvjgIiAvwqufOVRUfmPJFnJfMu_8",
            authDomain: "nx23-60263.firebaseapp.com",
            projectId: "nx23-60263",
            storageBucket: "nx23-60263.appspot.com",
            messagingSenderId: "256712374435",
            appId: "1:256712374435:web:2e20200def5f6a3828e716"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loadingView = document.getElementById('loading-view');
        const appContainer = document.getElementById('app-container');
        const logoutBtn = document.getElementById('logout-btn');

        // --- STATE MANAGEMENT ---
        let state;
        let userId; // To store the logged-in user's ID
        let dataRef; // To store the reference to the user's data document in Firestore

        const defaultState = {
            mainTitle: 'Productivity Hub',
            currentTheme: 'classic',
            checklists: { classic: [], 'wonder-woman': [], 'iron-man': [], batman: [] },
            achievements: {
                classic: { level: 0, mainQuote: "The future depends on what you do today." },
                'wonder-woman': { level: 0, mainQuote: "If no one else will defend the world, then I must." },
                'iron-man': { level: 0, mainQuote: "I am Iron Man." },
                batman: { level: 0, mainQuote: "It's not who I am underneath, but what I do that defines me." }
            },
        };

        // --- FIREBASE GATEKEEPER ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                // Use a path that is allowed by our security rules
                dataRef = doc(db, 'users', userId, 'private_data', 'main');
                loadDataFromFirebase();
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- FIREBASE DATA HANDLING ---
        async function loadDataFromFirebase() {
            try {
                const docSnap = await getDoc(dataRef);
                if (docSnap.exists()) {
                    const savedState = docSnap.data();
                    state = {
                        ...defaultState,
                        ...savedState,
                        achievements: { ...defaultState.achievements, ...savedState.achievements },
                        checklists: { ...defaultState.checklists, ...savedState.checklists },
                    };
                } else {
                    state = { ...defaultState };
                    // For a new user, save the default state immediately
                    await saveDataToFirebase(true); 
                }
            } catch (error) {
                console.error("Error loading data from Firestore:", error);
                state = { ...defaultState };
            } finally {
                init();
                loadingView.classList.add('hidden');
                appContainer.classList.remove('hidden');
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedSave = debounce(async () => {
             if (!dataRef) return;
            try {
                await setDoc(dataRef, state);
                const indicator = document.getElementById('save-indicator');
                indicator.classList.remove('opacity-0');
                setTimeout(() => indicator.classList.add('opacity-0'), 2000);
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }, 1500);

        async function saveDataToFirebase(immediate = false) {
            if (immediate) {
                await setDoc(dataRef, state).catch(e => console.error(e));
            } else {
                debouncedSave();
            }
        }

        // --- THEME ---
        function applyTheme(theme) {
            state.currentTheme = theme;
            document.body.className = `theme-${theme} bg-primary text-primary`;
            document.querySelectorAll('#theme-switcher .theme-btn').forEach(btn => {
                btn.style.borderColor = btn.dataset.theme === theme ? 'var(--accent-primary)' : 'transparent';
            });
            document.getElementById('main-title').textContent = state.mainTitle;
            updateBadge();
            renderChecklist();
        }
        
        // --- CHECKLIST LOGIC ---
        function renderChecklist(searchTerm = '') {
            const currentChecklist = state.checklists[state.currentTheme] || [];
            const checklistContainer = document.getElementById('checklist-container');
            checklistContainer.innerHTML = '';
            if (currentChecklist.length === 0 && !searchTerm) {
                checklistContainer.innerHTML = `<p class="text-secondary">No subjects yet. Add one to get started!</p>`;
                return;
            }
            const filteredChecklist = searchTerm ? filterChecklist(currentChecklist, searchTerm.toLowerCase()) : currentChecklist;
            filteredChecklist.forEach((subject, subjectIndex) => {
                const subjectEl = createChecklistItem(subject, [subjectIndex], 'subject', searchTerm);
                checklistContainer.appendChild(subjectEl);
            });
        }

        function createChecklistItem(item, indices, type, searchTerm) {
            const itemEl = document.createElement('div');
            itemEl.className = `checklist-item ${item.collapsed && !searchTerm ? 'collapsed' : ''}`;
            itemEl.dataset.type = type;
            itemEl.dataset.indices = indices.join(',');

            const childrenContainer = type !== 'subtopic' ? `<div class="children-container"></div>` : '';
            const checkboxHTML = `<input type="checkbox" class="item-checkbox mr-2" ${item.completed ? 'checked' : ''}>`;
            
            itemEl.innerHTML = `
                <div class="flex items-center justify-between p-2 rounded-md hover:bg-secondary">
                    <div class="flex items-center flex-grow min-w-0">
                        ${type !== 'subtopic' ? `<span class="collapsible-icon mr-2 cursor-pointer text-secondary">▼</span>` : ''}
                        ${checkboxHTML}
                        <span class="item-title text-primary cursor-pointer truncate">${item.title}</span>
                        <input type="text" class="item-edit-input hidden w-full bg-primary text-primary border-b border-theme" value="${item.title}">
                    </div>
                    <div class="flex items-center space-x-2 flex-shrink-0 ml-2">
                        ${type !== 'subtopic' ? `<button class="add-child-btn btn-theme-primary text-xs px-2 py-1 rounded">+</button>` : ''}
                        <button class="delete-item-btn text-red-500 hover:text-red-400 text-lg">🗑️</button>
                    </div>
                </div>
                ${childrenContainer}
            `;

            if (type !== 'subtopic' && (!item.collapsed || searchTerm) && item.children) {
                const childrenEl = itemEl.querySelector('.children-container');
                const childType = { subject: 'section', section: 'topic', topic: 'subtopic' }[type];
                item.children.forEach((child, childIndex) => {
                    childrenEl.appendChild(createChecklistItem(child, [...indices, childIndex], childType, searchTerm));
                });
            }
            return itemEl;
        }
        
        // --- GAMIFICATION ---
        function updateAchievements() {
            const completedCount = countCompletedTasks();
            const themeAchievements = state.achievements[state.currentTheme];
            const newLevel = Math.floor(completedCount / 5);
            if (newLevel > themeAchievements.level) {
                themeAchievements.level = newLevel;
            }
            updateBadge();
        }

        function countCompletedTasks() {
            let count = 0;
            function recurse(items) {
                items.forEach(item => {
                    if (item.children && item.children.length > 0) {
                        recurse(item.children);
                    } else if (item.completed) {
                        count++;
                    }
                });
            }
            recurse(state.checklists[state.currentTheme] || []);
            return count;
        }
        
        function updateBadge() {
            const themeAchievements = state.achievements[state.currentTheme];
            document.getElementById('badge-level').textContent = themeAchievements.level;
            document.getElementById('main-quote').textContent = `"${themeAchievements.mainQuote}"`;
            const badge = document.getElementById('achievement-badge');
            badge.className = 'w-24 h-24 mx-auto rounded-full flex items-center justify-center text-4xl font-bold cursor-pointer mb-2 transition-transform duration-300 hover:scale-110';
            const themeColors = { classic: ['bg-blue-500', 'text-white'], 'wonder-woman': ['bg-yellow-500', 'text-blue-900'], 'iron-man': ['bg-cyan-400', 'text-gray-900'], batman: ['bg-yellow-400', 'text-black'] };
            badge.classList.add(...themeColors[state.currentTheme]);
        }
        
        // --- UTILITY FUNCTIONS ---
        function openModal(id) { document.getElementById(id).classList.replace('hidden', 'flex'); }
        function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }
        
        function getItemByIndices(indices) {
            let items = state.checklists[state.currentTheme];
            let item = null;
            for (const index of indices) {
                if (!items || !items[index]) return null;
                item = items[index];
                items = item.children;
            }
            return item;
        }

        function deleteItemByIndices(indices) {
            let parent = { children: state.checklists[state.currentTheme] };
            for (let i = 0; i < indices.length - 1; i++) {
                parent = parent.children[indices[i]];
            }
            parent.children.splice(indices[indices.length - 1], 1);
        }

        function filterChecklist(nodes, term) {
            return nodes.map(node => ({...node})).filter(node => {
                if (node.children) node.children = filterChecklist(node.children, term);
                return node.title.toLowerCase().includes(term) || (node.children && node.children.length > 0);
            });
        }
        
        // --- INITIALIZATION & EVENT LISTENERS ---
        function init() {
            applyTheme(state.currentTheme);

            // Main Header Listeners
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged will redirect
                } catch (error) {
                    console.error("Logout Error:", error);
                }
            });
            document.getElementById('theme-switcher').addEventListener('click', e => { 
                if (e.target.matches('.theme-btn')) { 
                    applyTheme(e.target.dataset.theme); 
                    saveDataToFirebase(); 
                } 
            });
            document.getElementById('main-title').addEventListener('blur', e => { 
                state.mainTitle = e.target.textContent; 
                saveDataToFirebase(); 
            });
            document.getElementById('main-quote').addEventListener('blur', e => { 
                state.achievements[state.currentTheme].mainQuote = e.target.textContent; 
                saveDataToFirebase(); 
            });

            // Checklist Listeners
            document.getElementById('add-subject-btn').addEventListener('click', () => {
                const currentChecklist = state.checklists[state.currentTheme];
                currentChecklist.push({ title: 'New Subject', collapsed: false, completed: false, children: [] });
                renderChecklist();
                saveDataToFirebase();
            });
            document.getElementById('search-bar').addEventListener('input', e => renderChecklist(e.target.value));
            
            // Event delegation for checklist items
            document.getElementById('checklist-container').addEventListener('click', (e) => {
                const target = e.target;
                const itemEl = target.closest('.checklist-item');
                if (!itemEl) return;

                const indices = itemEl.dataset.indices.split(',').map(Number);
                let item = getItemByIndices(indices);
                if (!item) return;

                if (target.classList.contains('collapsible-icon')) {
                    item.collapsed = !item.collapsed;
                } else if (target.classList.contains('delete-item-btn')) {
                    if (confirm('Are you sure you want to delete this item and all its contents?')) {
                        deleteItemByIndices(indices);
                    }
                } else if (target.classList.contains('add-child-btn')) {
                    if (!item.children) item.children = [];
                    const childType = { subject: 'section', section: 'topic', topic: 'subtopic' }[itemEl.dataset.type];
                    item.children.push({ title: `New ${childType}`, completed: false, children: [] });
                    item.collapsed = false;
                } else if (target.classList.contains('item-title')) {
                    target.classList.add('hidden');
                    const input = target.nextElementSibling;
                    input.classList.remove('hidden');
                    input.focus();
                    input.select();
                } else if (target.classList.contains('item-checkbox')) {
                    item.completed = target.checked;
                    updateAchievements();
                }
                
                renderChecklist();
                saveDataToFirebase();
            });
            
            document.getElementById('checklist-container').addEventListener('focusout', (e) => {
                if (e.target.classList.contains('item-edit-input')) {
                    const input = e.target;
                    const itemEl = input.closest('.checklist-item');
                    const indices = itemEl.dataset.indices.split(',').map(Number);
                    let item = getItemByIndices(indices);
                    item.title = input.value.trim() || item.title;
                    renderChecklist();
                    saveDataToFirebase();
                }
            });

            document.getElementById('checklist-container').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.classList.contains('item-edit-input')) {
                    e.target.blur();
                }
            });

            // Modal Listeners
            document.getElementById('bulk-add-btn').addEventListener('click', () => openModal('bulk-add-modal'));
            document.getElementById('close-bulk-add-modal').addEventListener('click', () => closeModal('bulk-add-modal'));
            document.getElementById('process-bulk-add').addEventListener('click', () => {
                // Bulk add logic would go here
                alert("Bulk add functionality coming soon!");
                closeModal('bulk-add-modal');
            });
        }
    </script>
</body>
</html>
